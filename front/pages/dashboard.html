<!-- front/pages/createQuiz.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©er un Quiz</title>
  <link rel="icon" href="/static/assets/favicon.ico">
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
    .question-block { background: white; padding: 10px; margin-bottom: 20px; border-radius: 10px; }
    input, select, textarea { display: block; margin: 10px 0; width: 100%; padding: 5px; }
    button { margin: 10px 0; padding: 10px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>Cr√©er un nouveau Quiz</h2>
  <input type="text" id="titre" placeholder="Titre du quiz">
  <textarea id="description" placeholder="Description du quiz"></textarea>
  <label>Choisir la cat√©gorie</label>
  <select id="categorie"></select>
  <div id="questions-container"></div>
  <button onclick="addQuestion()">+ Ajouter une Question</button>
  <button onclick="submitQuiz()">üì§ Envoyer le Quiz</button>
  <div id="errorMessage" class="error"></div>
  <script>
    const baseUrl = "http://localhost:8000";
    const token = localStorage.getItem("token");

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    if (!token) {
      document.getElementById('errorMessage').textContent = 'Vous devez √™tre connect√©.';
      setTimeout(() => { window.location.href = '/pages/login.html'; }, 2000);
    }

    async function loadCategories() {
      try {
        const res = await fetch(`${baseUrl}/api/quizzes/api/categories/`, {
          headers: token ? { 'Authorization': `Token ${token}` } : {}
        });
        if (!res.ok) {
          throw new Error(`Erreur HTTP ${res.status}: ${await res.text()}`);
        }
        const categories = await res.json();
        const select = document.getElementById('categorie');
        select.innerHTML = ''; // Clear existing options
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.id;
          opt.textContent = cat.nom;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des cat√©gories: ' + error.message;
      }
    }

    function addQuestion() {
      const container = document.getElementById("questions-container");
      const block = document.createElement("div");
      block.className = "question-block";
      block.innerHTML = `
        <label>Texte de la question</label>
        <input type="text" name="questionTexte">
        <label>Type</label>
        <select name="questionType">
          <option value="text">Texte</option>
          <option value="image">Image</option>
        </select>
        <div class="choices">
          <label>Choix</label>
          <input type="text" name="choiceTexte">
          <input type="file" name="choiceImage">
        </div>
        <button type="button" onclick="addChoice(this)">+ Ajouter un autre choix</button>
      `;
      container.appendChild(block);
    }

    function addChoice(btn) {
      const div = document.createElement("div");
      div.className = "choices";
      div.innerHTML = `
        <input type="text" name="choiceTexte">
        <input type="file" name="choiceImage">
      `;
      btn.parentElement.appendChild(div);
    }


    async function submitQuiz() {
  const titre = document.getElementById("titre").value;
  const description = document.getElementById("description").value;
  const categorie = document.getElementById("categorie").value;

  const questions = [];
  const blocks = document.querySelectorAll(".question-block");
  blocks.forEach(block => {
    const texte = block.querySelector('[name="questionTexte"]').value;
    const type = block.querySelector('[name="questionType"]').value;
    const choices = [];
    block.querySelectorAll(".choices").forEach(choiceDiv => {
      const choiceTexte = choiceDiv.querySelector('[name="choiceTexte"]').value;
      if (choiceTexte) choices.push({ texte: choiceTexte });
    });
    questions.push({ texte, type, choices });
  });

  const quizData = { titre, description, categorie, questions };

  const res = await fetch(`${baseUrl}/api/quizzes/`, {
    method: "POST",
    headers: {
      'Authorization': `Token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(quizData)
  });

  const result = await res.json();
  console.log(result);
}
async function submitQuiz() {
  const titre = document.getElementById("titre").value;
  const description = document.getElementById("description").value;
  const categorie = document.getElementById("categorie").value;

  const questions = [];
  const blocks = document.querySelectorAll(".question-block");
  blocks.forEach(block => {
    const texte = block.querySelector('[name="questionTexte"]').value;
    const type = block.querySelector('[name="questionType"]').value;
    const choices = [];
    block.querySelectorAll(".choices").forEach(choiceDiv => {
      const choiceTexte = choiceDiv.querySelector('[name="choiceTexte"]').value;
      if (choiceTexte) choices.push({ texte: choiceTexte });
    });
    questions.push({ texte, type, choices });
  });

  const quizData = { titre, description, categorie, questions };

  const res = await fetch(`${baseUrl}/api/quizzes/`, {
    method: "POST",
    headers: {
      'Authorization': `Token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(quizData)
  });

  const result = await res.json();
  console.log(result);
}


    window.onload = loadCategories;
  </script>
</body>
</html>